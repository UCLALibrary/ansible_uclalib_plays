---

  # avuong
  # Playbook to create ssm parameters
  #

- name: uclalib_k8s_external_secrets_ssm_put.yml
  hosts:
    - k8s_ssm_external_secrets

  vars:
    # Currently does not support using profiles or environment variables. Keys must be interpolated into vars
    aws_access_key_id: "ENTERYOURACCESSKEY"
    aws_secret_access_key: "ENTERYOURSECRETKEY"
    kms_alias: "ENTERYOURKMSALIAS"

    # Superset of merged parameters to pass
    parameters: "{{ services_parameters + systems_parameters }}"
    team1_parameters:
      - prefix: "team1"
        namespace: "test"
        namespace_parameters:
          - parameter: "iiif_user"
            value: "admin"
          - parameter: "iiif_password"
            value: "password"
    team2_parameters:
      - prefix: "team2"
        namespace: "test"
        namespace_parameters:
          - parameter: "drupal_user"
            value: "user"
          - parameter: "drupal_pw"
            value: "password"

  tasks:
    - name: Create or update secure key/value pair with nominated kms key
      aws_ssm_parameter_store:
        name: "/{{ item.0.prefix }}/{{ item.0.namespace }}/{{ item.1.parameter }}"
        string_type: "SecureString"
        key_id: "{{ kms_alias }}"
        value: "{{ item.1.value }}"
        region: "{{ aws_region }}"
        aws_access_key: "{{ aws_access_key_id }}"
        aws_secret_key: "{{ aws_secret_access_key }}"
      with_subelements:
        - "{{ parameters }}"
        - namespace_parameters
      delegate_to: 127.0.0.1
